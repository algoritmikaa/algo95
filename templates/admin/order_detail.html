{% extends "base.html" %}

{% block title %}Заказ #{{ order.id }}{% endblock %}

{% block breadcrumbs %}
    <a href="{{ url_for('admin_orders') }}">Заказы</a>
    <span>Заказ #{{ order.id }}</span>
{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary-color);">
            <i class="fas fa-receipt"></i> Заказ #{{ order.id }}
        </h1>
        
        <a href="{{ url_for('admin_orders') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Назад к заказам
        </a>
    </div>
    
    <div class="row">
        <div class="col-8">
            <div class="card fade-in">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
                    {% if order.product.image %}
                    <img src="{{ url_for('static', filename=order.product.image) }}" 
                         alt="{{ order.product.name }}" 
                         style="width: 120px; height: 120px; object-fit: cover; border-radius: var(--radius);">
                    {% endif %}
                    
                    <div style="flex: 1;">
                        <h2 style="margin-bottom: 10px;">{{ order.product.name }}</h2>
                        <p style="color: var(--text-light); margin-bottom: 15px;">
                            {{ order.product.description if order.product.description else 'Нет описания' }}
                        </p>
                        
                        <div style="display: flex; gap: 20px;">
                            <div>
                                <span style="color: var(--text-light); font-size: 0.9rem;">Цена:</span>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                    {{ order.product.price }} баллов
                                </div>
                            </div>
                            
                            <div>
                                <span style="color: var(--text-light); font-size: 0.9rem;">Количество:</span>
                                <div style="font-size: 1.5rem; font-weight: bold;">
                                    ×{{ order.quantity }}
                                </div>
                            </div>
                            
                            <div>
                                <span style="color: var(--text-light); font-size: 0.9rem;">Итого:</span>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-dark);">
                                    {{ order.product.price * order.quantity }} баллов
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="info-card">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                <i class="fas fa-user"></i> Информация о покупателе
                            </h4>
                            
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 60px; height: 60px; background: var(--primary-color); 
                                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user-graduate" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                
                                <div>
                                    <h5 style="margin-bottom: 5px;">
                                        {{ order.student.first_name }} {{ order.student.last_name }}
                                    </h5>
                                    <p style="color: var(--text-light); margin-bottom: 0;">
                                        {{ order.student.username }} • 
                                        {{ order.student.group.name if order.student.group else 'Без группы' }}
                                    </p>
                                </div>
                            </div>
                            
                            <div style="background: rgba(123, 31, 162, 0.05); padding: 15px; border-radius: var(--radius);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Баланс баллов:</span>
                                    <span style="font-weight: bold; color: var(--primary-color);">
                                        {{ order.student.points }} баллов
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Заказано товаров:</span>
                                    <span style="font-weight: bold;">
                                        {{ order.student.orders|selectattr('status', 'equalto', 'completed')|list|length }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="info-card">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                <i class="fas fa-info-circle"></i> Информация о заказе
                            </h4>
                            
                            <div style="background: rgba(123, 31, 162, 0.05); padding: 15px; border-radius: var(--radius);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Дата заказа:</span>
                                    <span style="font-weight: bold;">
                                        {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Статус:</span>
                                    <span class="order-status status-{{ order.status }}" style="font-size: 0.9rem;">
                                        {% if order.status == 'pending' %}
                                        <i class="fas fa-clock"></i> Ожидает выдачи
                                        {% elif order.status == 'completed' %}
                                        <i class="fas fa-check"></i> Выдан
                                        {% else %}
                                        <i class="fas fa-times"></i> Отменен
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Номер заказа:</span>
                                    <span style="font-weight: bold; color: var(--primary-color);">
                                        #{{ order.id }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-4">
            <div class="card fade-in">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fas fa-cogs"></i> Управление заказом
                </h3>
                
                {% if order.status == 'pending' %}
                <form method="POST" style="margin-bottom: 20px;">
                    <button type="submit" name="complete" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> Отметить как выданный
                    </button>
                    
                    <button type="submit" name="cancel" class="btn btn-danger" style="width: 100%;"
                            onclick="return confirm('Вы уверены, что хотите отменить заказ? Баллы будут возвращены ученику.')">
                        <i class="fas fa-times-circle"></i> Отменить заказ
                    </button>
                </form>
                {% endif %}
                
                <div style="background: {% if order.status == 'pending' %}rgba(255, 152, 0, 0.1){% elif order.status == 'completed' %}rgba(76, 175, 80, 0.1){% else %}rgba(244, 67, 54, 0.1){% endif %}; 
                            padding: 20px; border-radius: var(--radius);">
                    <h4 style="color: {% if order.status == 'pending' %}var(--warning-color){% elif order.status == 'completed' %}var(--success-color){% else %}var(--danger-color){% endif %}; 
                        margin-bottom: 15px;">
                        Статус: 
                        {% if order.status == 'pending' %}
                        Ожидает выдачи
                        {% elif order.status == 'completed' %}
                        Выдан
                        {% else %}
                        Отменен
                        {% endif %}
                    </h4>
                    
                    {% if order.status == 'pending' %}
                    <p style="margin-bottom: 0;">
                        <i class="fas fa-info-circle"></i> 
                        Заказ ожидает выдачи ученику. После выдачи нажмите "Отметить как выданный".
                    </p>
                    {% elif order.status == 'completed' %}
                    <p style="margin-bottom: 0;">
                        <i class="fas fa-check-circle"></i> 
                        Заказ был выдан ученику {{ order.student.first_name }} {{ order.student.last_name }}.
                    </p>
                    {% else %}
                    <p style="margin-bottom: 0;">
                        <i class="fas fa-times-circle"></i> 
                        Заказ был отменен. Баллы возвращены ученику.
                    </p>
                    {% endif %}
                </div>
            </div>
            
            {% if order.status == 'completed' %}
            <div class="card fade-in" style="margin-top: 20px;">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    <i class="fas fa-history"></i> История заказа
                </h3>
                
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <i class="fas fa-calendar-plus" style="color: var(--primary-color); margin-right: 10px;"></i>
                        <div>
                            <strong>Создан</strong><br>
                            <small style="color: var(--text-light);">
                                {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </small>
                        </div>
                    </li>
                    
                    <li style="padding: 10px 0;">
                        <i class="fas fa-check-circle" style="color: var(--success-color); margin-right: 10px;"></i>
                        <div>
                            <strong>Выдан</strong><br>
                            <small style="color: var(--text-light);">
                                Дата выдачи: {{ order.created_at.strftime('%d.%m.%Y') }}
                            </small>
                        </div>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.info-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    height: 100%;
}

.order-status {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-pending {
    background: rgba(255, 152, 0, 0.15);
    color: var(--warning-color);
    border: 1px solid rgba(255, 152, 0, 0.3);
}

.status-completed {
    background: rgba(76, 175, 80, 0.15);
    color: var(--success-color);
    border: 1px solid rgba(76, 175, 80, 0.3);
}

.status-cancelled {
    background: rgba(244, 67, 54, 0.15);
    color: var(--danger-color);
    border: 1px solid rgba(244, 67, 54, 0.3);
}
</style>
{% endblock %}