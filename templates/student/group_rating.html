{% extends "base.html" %}

{% block title %}Рейтинг группы - {{ group.name }}{% endblock %}

{% block breadcrumbs %}
    <span>Рейтинг группы</span>
{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary-color);">
            <i class="fas fa-trophy"></i> Рейтинг группы {{ group.name }}
        </h1>
        
        <a href="{{ url_for('student_profile') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i> Назад в профиль
        </a>
    </div>
    
    <div class="card fade-in">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="display: inline-block; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); 
                        color: white; padding: 10px 30px; border-radius: var(--radius);">
                <h3 style="margin: 0; color: white;">Рейтинг по начисленным баллам</h3>
            </div>
            <p style="color: var(--text-light); margin-top: 10px;">
                Баллы за покупки не влияют на рейтинг. Только начисленные баллы за достижения.
            </p>
        </div>
        
        {% if students %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 80px;">Место</th>
                        <th>Ученик</th>
                        <th>Начисленные баллы</th>
                        <th>Текущие баллы</th>
                        <th>Разница</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="{% if student.id == current_user.id %}current-user-row{% endif %}">
                        <td>
                            <div class="rating-place">
                                {% if student.rating_position == 1 %}
                                <i class="fas fa-crown" style="color: gold;"></i>
                                {% elif student.rating_position == 2 %}
                                <i class="fas fa-medal" style="color: silver;"></i>
                                {% elif student.rating_position == 3 %}
                                <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                {% else %}
                                {{ student.rating_position }}
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; background: 
                                            {% if student.id == current_user.id %}var(--primary-color){% else %}var(--border-color){% endif %}; 
                                            border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: 
                                        {% if student.id == current_user.id %}white{% else %}var(--text-light){% endif %};"></i>
                                </div>
                                <div>
                                    <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                    {% if student.id == current_user.id %}
                                    <div style="color: var(--primary-color); font-size: 0.8rem;">
                                        <i class="fas fa-user"></i> Это вы
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: var(--success-color);">
                                {{ student.earned_points }}
                            </span>
                        </td>
                        <td>
                            <span style="font-weight: bold; color: var(--primary-color);">
                                {{ student.points }}
                            </span>
                        </td>
                        <td>
                            {% set difference = student.earned_points - student.points %}
                            <span style="font-weight: bold; color: 
                                {% if difference > 0 %}var(--danger-color){% else %}var(--success-color){% endif %};">
                                {% if difference > 0 %}-{{ difference }}{% else %}+{{ -difference }}{% endif %}
                            </span>
                            <small style="color: var(--text-light); display: block;">
                                {% if difference > 0 %}потрачено{% else %}сэкономлено{% endif %}
                            </small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <div>
                <span style="color: var(--text-light);">
                    Всего учеников в группе: {{ students|length }}
                </span>
            </div>
            
            <div>
                <span style="font-weight: bold;">
                    Ваше место: 
                    <span style="color: var(--primary-color);">
                        {% for student in students %}
                            {% if student.id == current_user.id %}
                                {{ student.rating_position }}
                            {% endif %}
                        {% endfor %}
                    </span>
                </span>
            </div>
        </div>
        
        {% else %}
        <div style="text-align: center; padding: 50px; color: var(--text-light);">
            <i class="fas fa-users" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3>В группе нет учеников</h3>
            <p>Рейтинг будет доступен, когда в группе появятся ученики</p>
        </div>
        {% endif %}
    </div>
    
    <div class="row" style="margin-top: 30px;">
        <div class="col-6">
            <div class="card fade-in">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i> Как работает рейтинг?
                </h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="info-card">
                        <div class="info-icon" style="background: var(--primary-color);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px; font-size: 1rem;">Начисленные баллы</h4>
                            <p style="color: var(--text-light); margin-bottom: 0; font-size: 0.9rem;">
                                Учитываются только баллы, полученные за достижения
                            </p>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-icon" style="background: var(--warning-color);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px; font-size: 1rem;">Покупки не влияют</h4>
                            <p style="color: var(--text-light); margin-bottom: 0; font-size: 0.9rem;">
                                Потраченные баллы не уменьшают ваш рейтинг
                            </p>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-icon" style="background: var(--success-color);">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px; font-size: 1rem;">Призы за первые места</h4>
                            <p style="color: var(--text-light); margin-bottom: 0; font-size: 0.9rem;">
                                Лучшие ученики получают подарки в конце месяца
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-6">
            <div class="card fade-in">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fas fa-chart-line"></i> Ваша позиция
                </h3>
                
                <div style="text-align: center; padding: 20px;">
                    {% set current_position = 0 %}
                    {% for student in students %}
                        {% if student.id == current_user.id %}
                            {% set current_position = student.rating_position %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if current_position > 0 %}
                    <div class="position-circle">
                        <div class="position-number">{{ current_position }}</div>
                        <div class="position-label">
                            {% if current_position == 1 %}
                            Первое место!
                            {% elif current_position == 2 %}
                            Второе место
                            {% elif current_position == 3 %}
                            Третье место
                            {% elif current_position <= 10 %}
                            Топ-10
                            {% else %}
                            Место в рейтинге
                            {% endif %}
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                            До следующего места:
                        </h4>
                        
                        {% if current_position > 1 %}
                            {% set prev_student = students[current_position-2] %}
                            {% set difference = prev_student.earned_points - current_user.earned_points %}
                            <div style="background: rgba(123, 31, 162, 0.05); padding: 15px; border-radius: var(--radius);">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                    {{ difference }} баллов
                                </div>
                                <p style="color: var(--text-light); margin-top: 5px;">
                                    нужно набрать, чтобы подняться на {{ current_position - 1 }} место
                                </p>
                            </div>
                        {% else %}
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: var(--radius);">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                                    Вы лидер!
                                </div>
                                <p style="color: var(--text-light); margin-top: 5px;">
                                    Продолжайте в том же духе
                                </p>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.rating-place {
    width: 40px;
    height: 40px;
    background: var(--bg-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 0 auto;
}

.current-user-row {
    background: rgba(123, 31, 162, 0.05) !important;
    border-left: 4px solid var(--primary-color);
}

.info-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: rgba(123, 31, 162, 0.05);
    border-radius: var(--radius);
}

.info-icon {
    width: 40px;
    height: 40px;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.position-circle {
    width: 150px;
    height: 150px;
    border: 8px solid var(--primary-color);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    background: var(--card-bg);
}

.position-number {
    font-size: 3rem;
    font-weight: bold;
    color: var(--primary-color);
    line-height: 1;
}

.position-label {
    font-size: 0.9rem;
    color: var(--text-light);
    margin-top: 5px;
}
</style>
{% endblock %}