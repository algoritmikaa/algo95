{% extends "base.html" %}

{% block title %}Группа - {{ group.name }}{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary-color);">
            <i class="fas fa-layer-group"></i> Группа: {{ group.name }}
        </h1>
        
        <a href="{{ url_for('admin_groups') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Назад к списку
        </a>
    </div>
    
    <div class="row">
        <div class="col-4">
            <div class="card fade-in">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Редактирование группы</h3>
                
                <form method="POST">
                    <div class="form-group">
                        <label class="form-label">Название группы</label>
                        <input type="text" name="name" class="form-control" value="{{ group.name }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Преподаватель</label>
                        <select name="teacher_id" class="form-control">
                            <option value="">Не назначен</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}" 
                                    {% if group.teacher_id == teacher.id %}selected{% endif %}>
                                {{ teacher.first_name }} {{ teacher.last_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                </form>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">Статистика группы</h4>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Учеников:</span>
                        <span style="font-weight: bold;">{{ students|length }}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Средний рейтинг:</span>
                        <span style="font-weight: bold;">
                            {% if students %}
                                {{ (students|sum(attribute='earned_points') / students|length)|round|int }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <span>Всего начислено:</span>
                        <span style="font-weight: bold; color: var(--success-color);">
                            {{ students|sum(attribute='earned_points') }}
                        </span>
                    </div>
                </div>
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <form method="POST" onsubmit="return confirm('Вы уверены, что хотите удалить эту группу? Все ученики будут перемещены в \"Без группы\".');">
                        <button type="submit" name="delete_group" class="btn btn-danger" style="width: 100%;">
                            <i class="fas fa-trash"></i> Удалить группу
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-8">
            <div class="card fade-in">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                    <i class="fas fa-trophy"></i> Рейтинг учеников ({{ students|length }})
                </h3>
                
                {% if students %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Место</th>
                                <th>Имя Фамилия</th>
                                <th>Начисленные баллы</th>
                                <th>Текущие баллы</th>
                                <th>Разница</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>
                                    <div class="rating-place-admin">
                                        {% if student.rating_position == 1 %}
                                        <i class="fas fa-crown" style="color: gold;"></i>
                                        {% elif student.rating_position == 2 %}
                                        <i class="fas fa-medal" style="color: silver;"></i>
                                        {% elif student.rating_position == 3 %}
                                        <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                        {% else %}
                                        {{ student.rating_position }}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>{{ student.first_name }} {{ student.last_name }}</td>
                                <td>
                                    <span style="font-weight: bold; color: var(--success-color);">
                                        {{ student.earned_points }}
                                    </span>
                                </td>
                                <td>
                                    <span style="font-weight: bold; color: var(--primary-color);">
                                        {{ student.points }}
                                    </span>
                                </td>
                                <td>
                                    {% set difference = student.earned_points - student.points %}
                                    <span style="color: 
                                        {% if difference > 0 %}var(--danger-color){% else %}var(--success-color){% endif %};">
                                        {% if difference > 0 %}-{{ difference }}{% else %}+{{ -difference }}{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('user_detail', user_id=student.id) }}" 
                                       class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                    <i class="fas fa-users-slash" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>
                    <h4>В группе нет учеников</h4>
                    <p>Добавьте учеников через раздел "Управление пользователями"</p>
                </div>
                {% endif %}
            </div>
            
            {% if group.teacher %}
            <div class="card fade-in" style="margin-top: 20px;">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">Преподаватель группы</h3>
                
                <div style="display: flex; align-items: center; gap: 20px; padding: 15px; background: rgba(123, 31, 162, 0.1); border-radius: var(--radius);">
                    <div style="width: 60px; height: 60px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    
                    <div style="flex: 1;">
                        <h4 style="margin-bottom: 5px;">{{ group.teacher.first_name }} {{ group.teacher.last_name }}</h4>
                        <p style="color: var(--text-light); margin-bottom: 0;">
                            Логин: {{ group.teacher.username }}
                        </p>
                    </div>
                    
                    <a href="{{ url_for('user_detail', user_id=group.teacher.id) }}" class="btn btn-primary">
                        <i class="fas fa-user-circle"></i> Профиль
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.rating-place-admin {
    width: 35px;
    height: 35px;
    background: var(--bg-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin: 0 auto;
}
</style>
{% endblock %}